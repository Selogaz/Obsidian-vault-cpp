const { type } = input;
const prefix = type;

// Configuration objects with [tag, display_label] format
const TYPE_CONFIGS = {
  sources: {
    paper: ['source/article/paper', 'üìÉ paper'],
    resource: ['source/article/resource', 'üåê resource'],
    book: ['source/book', 'üìö book'],
    course: ['source/course', 'üéì course'],
    movie: ['source/cinematic/movie', 'üé¨ movie'],
    series: ['source/cinematic/series', 'üçø series'],
    anime: ['source/cinematic/anime', 'üå∏ anime'],
    podcast: ['source/podcast', 'üìª podcast'],
    video: ['source/video/recording', 'üìπ recording'],
    playlist: ['source/video/playlist', 'üìº playlist'],
    album: ['source/music/album', 'üíΩ album'],
    tracklist: ['source/music/tracklist', 'üéß tracklist'],
    game: ['source/game', 'üéÆ game'],
  },
  fun: {
    movie: ['source/cinematic/movie', 'üé¨ movie'],
    series: ['source/cinematic/series', 'üçø series'],
    anime: ['source/cinematic/anime', 'üå∏ anime'],
    album: ['source/music/album', 'üíΩ album'],
    tracklist: ['source/music/tracklist', 'üéß tracklist'],
    game: ['source/game', 'üéÆ game'],
  },
  projects: {
    short: ['project/short', 'üóûÔ∏è short'],
    single: ['project/single', '‚úèÔ∏è single'],
    longform: ['project/longform', 'üñäÔ∏è longform'],
  },
  contacts: {
    working: ['contact/working', 'üë§ working'],
    client: ['contact/client', 'ü§ù client'],
    personal: ['contact/personal', 'üßë‚Äçü§ù‚Äçüßë personal'],
    routine: ['contact/routine', 'üßü routine'],
  },
  creators: {
    writer: ['creator/writer', 'üë©üèª‚Äçüíª writer'],
    director: ['creator/director', 'üßë‚Äç‚úàÔ∏è director'],
    researcher: ['creator/researcher', 'üßë‚Äçüî¨ researcher'],
    contentmaker: ['creator/contentmaker', 'ü¶∏ contentmaker'],
    businessman: ['creator/businessman', 'ü´Ö businessman'],
    expert: ['creator/expert', 'üòé expert'],
    musician: ['creator/musician', 'üßë‚Äçüé§ musician'],
    composer: ['creator/composer', 'üéº composer'],
    actor: ['creator/actor', 'ü§µ actor'],
    painter: ['creator/painter', 'üßë‚Äçüé® painter'],
    photographer: ['creator/photographer', 'üì∑ photographer'],
    cinematographer: ['creator/cinematographer', 'üé• cinematographer'],
  },
  productions: {
    channel: ['production/channel', 'üîî channel'],
    podcast: ['production/podcast', 'üîî podcast'],
    film_studio: ['production/film_studio', 'üéõÔ∏è film studio'],
    art_studio: ['production/art_studio', 'üéõÔ∏è art studio'],
    game_studio: ['production/game_studio', 'üéõÔ∏è game studio'],
    label: ['production/label', 'üéõÔ∏è label'],
    band: ['production/band', 'üé∏ band'],
    organization: ['production/organization', 'üè¢ organization'],
    company: ['production/company', 'üíº company'],
    platform: ['production/platform', 'üè® platform'],
    publisher: ['production/publisher', 'üñ® publisher'],
    journal: ['production/journal', 'üì∞ journal'],
  },
};

const STATUS_CONFIGS = {
  source_status: {
    todo: ['üü•', 'üü• todo'],
    wip: ['üü¶', 'üü¶ wip'],
    atom: ['‚öõ', '‚öõ atom'],
    done: ['üü©', 'üü© done'],
    drop: ['‚¨õ', '‚¨õ drop'],
  },
  project_status: {
    todo: ['üü•', 'üü• todo'],
    wip: ['üü¶', 'üü¶ wip'],
    done: ['üü©', 'üü© done'],
    published: ['üì¢', 'üì¢ published'],
    hold: ['‚ùÑ', '‚ùÑ hold'],
    drop: ['‚¨õ', '‚¨õ drop'],
  },
};

const MISC_CONFIGS = {
  relevance: {
    relevant: [true, 'üìå relevant'],
    irrelevant: [false, 'irrelevant'],
  },
  priorities: {
    a: ['üá¶', 'üá¶ Important and urgent'],
    b: ['üáß', 'üáß Important and non-urgent'],
    c: ['üá®', 'üá® Common'],
    d: ['üá©', 'üá© Delegate'],
    e: ['üá™', 'üá™ Eliminate'],
  },
  ratings: {
    masterpiece: ['üåï', 'üåï Masterpiece'],
    great: ['üåî', 'üåî Great'],
    good: ['üåì', 'üåì Good'],
    mediocre: ['üåí', 'üåí Mediocre'],
    poor: ['üåë', 'üåë Poor'],
  },
  scientificity: {
    primary: ['üÖ∞Ô∏è', 'üÖ∞Ô∏è Primary Research'],
    secondary: ['üÖ±Ô∏è', 'üÖ±Ô∏è Secondary Research'],
    expert: ['üëì', 'üëì Expert - Industry'],
    popular: ['üì¢', 'üì¢ Popular Science - Journalism'],
    unverified: ['üí¨', 'üí¨ Unverified - Opinion'],
  },
};

// Key configurations for different prefixes
const PREFIX_KEYS = {
  source: [
    'sources',
    'source_status',
    'scientificity',
    'rating',
    'category',
    'meta',
    'problem',
    'creator',
    'production',
    'title',
  ],
  fun: ['fun', 'source_status', 'rating', 'creator', 'genre'],
  project: [
    'projects',
    'project_status',
    'priority',
    'category',
    'meta',
    'problem',
    'creator',
    'production',
    'title',
  ],
  contact: [
    'relevant',
    'contacts',
    'category',
    'meta',
    'problem',
    'production',
    'title',
  ],
  creator: [
    'relevant',
    'creators',
    'category',
    'meta',
    'problem',
    'production',
    'title',
  ],
  production: [
    'relevant',
    'productions',
    'category',
    'meta',
    'problem',
    'production',
    'title',
  ],
  hierarchy: ['relevant', 'category', 'meta', 'problem', 'title'],
  meta: ['relevant', 'category', 'title'],
  problem: ['relevant', 'category', 'meta', 'title'],
};

// Get pages query based on prefix
function getPagesQuery(prefix) {
  const {
    file: { path, name },
  } = dv.current();

  const sourceTag =
    prefix === 'fun'
      ? `(${Object.values(TYPE_CONFIGS.fun)
          .map(([path]) => `#${path}`)
          .join(' OR ')})`
      : `#${prefix}`;

  const categoryTag = path.startsWith('base/categories/')
    ? ` AND #category/${name.replace(/ /g, '_')}`
    : '';

  return ['hierarchy', 'meta', 'problem'].includes(prefix)
    ? `#system/high/${prefix}${categoryTag}`
    : `${sourceTag}${categoryTag}`;
}

// Single pages query - main performance optimization
const pages = dv.pages(getPagesQuery(prefix));

// Extract unique field values once and cache results
const fieldCache = new Map();

function getUniqueFieldValues(fieldName) {
  if (fieldCache.has(fieldName)) {
    return fieldCache.get(fieldName);
  }

  const values = pages
    .where((p) => p.file.frontmatter[fieldName])
    .array()
    .flatMap((p) => p.file.frontmatter[fieldName])
    .map((x) => String(x).replace(/\[\[([^\|\]]+)(?:\|[^\]]*)?\]\]/g, '$1'));

  const uniqueValues = [...new Set(values)];
  fieldCache.set(fieldName, uniqueValues);
  return uniqueValues;
}

// Generate options from structure
function generateOptionsFromStructure(config) {
  return Object.values(config)
    .map(([value, label]) => `option('${value}', '${label}')`)
    .join(', ');
}

// Generate options from dataview field
function generateOptionsFromDataview(fieldName, defaultIcon) {
  return getUniqueFieldValues(fieldName)
    .map((value) => {
      const escapedValue = value.replace(/'/g, "\\'");
      return `option('${escapedValue}', '${defaultIcon} ${escapedValue}')`;
    })
    .join(', ');
}

// Filter definitions with lazy evaluation
const FILTER_DEFINITIONS = {
  // Type filters
  sources: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.sources
    )}):${prefix}_type]\``,
  ],
  fun: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.fun
    )}):${prefix}_type]\``,
  ],
  projects: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.projects
    )}):${prefix}_type]\``,
  ],
  contacts: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.contacts
    )}):${prefix}_type]\``,
  ],
  creators: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.creators
    )}):${prefix}_type]\``,
  ],
  productions: () => [
    'üóÑÔ∏è',
    `${prefix}_type`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      TYPE_CONFIGS.productions
    )}):${prefix}_type]\``,
  ],

  // Status filters
  source_status: () => [
    'üíØ',
    `${prefix}_status`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      STATUS_CONFIGS.source_status
    )}):${prefix}_status]\``,
  ],
  project_status: () => [
    'üíØ',
    `${prefix}_status`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      STATUS_CONFIGS.project_status
    )}):${prefix}_status]\``,
  ],

  // Priority and relevance
  priority: () => [
    'üî∫',
    `${prefix}_priority`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      MISC_CONFIGS.priorities
    )}):${prefix}_priority]\``,
  ],
  relevant: () => [
    'üìå',
    `${prefix}_relevant`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      MISC_CONFIGS.relevance
    )}):${prefix}_relevant]\``,
  ],

  // Scientific and rating
  scientificity: () => [
    'üÖ∞Ô∏è',
    `${prefix}_scientificity`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      MISC_CONFIGS.scientificity
    )}):${prefix}_scientificity]\``,
  ],
  rating: () => [
    'üåïÔ∏è',
    `${prefix}_rating`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromStructure(
      MISC_CONFIGS.ratings
    )}):${prefix}_rating]\``,
  ],

  // Dynamic fields from pages
  category: () => [
    'üó∫Ô∏è',
    `${prefix}_category`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'category',
      'üó∫Ô∏è'
    )}):${prefix}_category]\``,
  ],
  meta: () => [
    'üîé',
    `${prefix}_meta`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'meta',
      'üîé'
    )}):${prefix}_meta]\``,
  ],
  problem: () => [
    '‚ö°Ô∏è',
    `${prefix}_problem`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'problem',
      '‚ö°Ô∏è'
    )}):${prefix}_problem]\``,
  ],
  genre: () => [
    'üé≠',
    `${prefix}_genre`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'genre',
      'üé≠'
    )}):${prefix}_genre]\``,
  ],
  creator: () => [
    'üë®',
    `${prefix}_creator`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'creator',
      'üë®'
    )}):${prefix}_creator]\``,
  ],
  production: () => [
    'üè¨',
    `${prefix}_production`,
    `\`INPUT[inlineListSuggester(${generateOptionsFromDataview(
      'production',
      'üè¨'
    )}):${prefix}_production]\``,
  ],

  // Title search
  title: () => [
    'üî§',
    `${prefix}_title`,
    `\`INPUT[text(placeholder('Search')):${prefix}_title]\``,
  ],
};

// Get keys for current prefix and generate queries
const keys = PREFIX_KEYS[prefix] || [];
const queries = keys.map((key) => {
  const [icon, , input] = FILTER_DEFINITIONS[key]();
  return [icon, input];
});

// Render filter buttons
queries.forEach(([icon, input]) => {
  dv.el('span', `${icon} ${input}`, {
    attr: {
      style:
        'display:inline-block;border:1px solid #404040;border-radius:4px;padding:3px; margin:2px;',
    },
  });
});
