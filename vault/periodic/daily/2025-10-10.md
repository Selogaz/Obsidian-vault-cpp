---
tags:
  - periodic/day
up:
  - "[[periodic/weekly/2025-W41|2025-W41]]"
updated: 2025-10-10T20:10:58+03:00
reviewed: false
---

```toc
```

I'll scan key config and service/controller files to pinpoint concrete issues and suggest fixes grounded in your code. Then I'll summarize prioritized improvements.

[5 tools called]

I'll open core services, entities, and repositories to spot concrete problems in indexing/search logic and persistence mappings.

[5 tools called]

I изучил `pom.xml`, Docker-файлы, `application.yaml`, контроллеры и ключевые сервисы. Ниже — конкретные проблемы и короткие рекомендации, как исправить.

### Архитектура слоёв и зависимости
- **Смешение слоёв: `SearchService implements SearchRepository`**
  - Проблема: сервис реализует репозиторий, что ломает архитектуру (Repository — порт к БД, Service — бизнес-логика).
  - Исправление: убрать `implements SearchRepository` у `searchengine.services.SearchService`; оставить внедрение `IndexRepository`, `PageRepository`, `LemmaRepository`, `SiteRepository`. Методы репозитория должны быть в интерфейсах Spring Data JPA в пакете `repository`.
- **Интерфейс `StatisticsService` лежит в пакете `repository`**
  - Проблема: сервисный интерфейс в пакете репозиториев путает семантику и авто‑сканирование.
  - Исправление: переместить `searchengine.repository.StatisticsService` в пакет `searchengine.services` (и обновить импорты в `ApiController` и имплементацию).
- **Смешение DI-стилей**
  - Проблема: в `SearchService` используется `@Autowired` конструктор, а в других местах — Lombok `@RequiredArgsConstructor`. Смешение усложняет стиль и тестирование.
  - Исправление: везде использовать конструктор через Lombok `@RequiredArgsConstructor` и удалить `@Autowired` конструктор.

### Конфигурация и безопасность
- **Тайные данные в `application.yaml`**
  - Проблема: логин/пароль к БД и URL в `src/main/resources/application.yaml`. В проде это утечка.
  - Исправление: вынести в переменные окружения/`application-docker.yaml`/`application-prod.yaml`. Локально — `application-dev.yaml`. Подключать через `SPRING_PROFILES_ACTIVE`.
- **`spring.jpa.hibernate.ddl-auto: create`**
  - Проблема: каждый запуск пересоздаёт схему, потеря данных.
  - Исправление: dev — `update`, prod — `validate` + миграции Flyway/Liquibase.
- **Дублирование `application.yaml` в корне и в ресурсах**
  - Проблема: файл в корне может путать разработчиков и CI. Работает только `src/main/resources/application.yaml`.
  - Исправление: удалить корневой `application.yaml` либо сделать его шаблоном `.example`.
- **Жёстко заданный порт `server.port: 8081`**
  - Проблема: сложно параметризовать под окружения.
  - Исправление: перенести в профиль/переменную окружения `SERVER_PORT`.
- **Реестр Maven `skillbox-gitlab`**
  - Проблема: внешний приватный/ненадёжный репозиторий может ломать сборку.
  - Исправление: по возможности перейти на центральный Maven Central или задокументировать доступ/кэш.

### Зависимости и версии
- **Spring Boot 2.7.1 на Java 17**
  - Проблема: 2.7 — EOL; стек безопасности/совместимость хуже.
  - Исправление: обновиться до Spring Boot 3.3.x, Jakarta API, и JPA‑маппинги/импорты подправить.
- **Логирование дублируется**
  - Проблема: добавлены `slf4j-api` и `logback-classic`, хотя `spring-boot-starter-web` уже подтягивает корректный стек логирования. Возможны конфликты версий.
  - Исправление: удалить явные зависимости на `slf4j-api` и `logback-classic`.
- **MySQL драйвер без версии и старый координат**
  - Проблема: `mysql:mysql-connector-java` (scope runtime) без версии. В Boot 3 рекомендуется `com.mysql:mysql-connector-j`. В Boot 2 — версией управляет parent, но лучше явно перейти на новый groupId при апгрейде.
  - Исправление: при апгрейде на Boot 3 заменить на `com.mysql:mysql-connector-j` и доверить версию Spring BOM.

### Docker и окружение
- **Несогласованность настроек БД**
  - Проблема: в приложении URL `jdbc:mysql://localhost:3306...`, а в Compose — переопределяется на `db`. Локальный запуск без Compose упирается в локальный MySQL.
  - Исправление: использовать профили: `application-docker.yaml` (host `db`), `application-dev.yaml` (host `localhost`), активировать через профили и документацию.
- **Health/ready‑wait приложения**
  - Проблема: app стартует, когда БД здорова, но нет retry/backoff в самом приложении. При холодном старте возможны ошибки подключения.
  - Исправление: добавить `spring.sql.init.continue-on-error=true` при инициализации, конфигурировать пул с retry, либо добавить `restart: unless-stopped` и `depends_on` уже есть, ок.
- **Порт‑маппинг**
  - Норма: Docker — `8082:8081`, `Dockerfile` `EXPOSE 8081`. Ок, просто задокументировать.
- **Имя JAR фиксировано**
  - Проблема: `COPY target/SearchEngine-1.0-SNAPSHOT.jar app.jar` ломается при изменении версии.
  - Исправление: использовать аргумент сборки или шаблон в CI, либо `mvn -DskipTests package` и COPY по имени из `${project.build.finalName}.jar` (в CI).

### Индексация и конкуренция
- **Опасное удаление данных при старте индексации**
  - Проблема: `clearAllSites()` удаляет все `lemma/index/page/site`. Это разрушительно.
  - Исправление: индексацию делать инкрементальной; удалять только данные по сайту или по странице; предусмотреть флаги.
- **Ручное управление потоками и `ForkJoinPool`**
  - Проблема: смешаны `Thread`, `ForkJoinPool`, `ThreadPoolExecutor` (который не используется), `CopyOnWriteArrayList tasks`, но `tasks` не наполняется. Возможны гонки и утечки.
  - Исправление:
    - Использовать либо `ForkJoinPool` (и не плодить `Thread` на сайт), либо `TaskExecutor` Spring.
    - Реально регистрировать саб‑задачи в `tasks` если хотите их отменять.
    - Не синхронизироваться на `site.getUrl().intern()` — это риск lock‑контеншна JVM‑wide. Использовать locks per siteId.
- **Транзакции и многопоточность**
  - Проблема: `@Transactional` методы вызываются из потоков, создаваемых руками — контекст транзакции и прокси могут не работать как ожидается.
  - Исправление: переносить параллелизм внутрь сервисов с `@Async` и использовать менеджер транзакций корректно; оборачивать каждый юнит работы своей транзакцией.
- **HTTP‑скачивание без роботов и rate limit**
  - Проблема: `Jsoup.connect` без `robots.txt`, без politeness delay, без retry/backoff; нет хедеров по домену.
  - Исправление: добавить проверку `robots.txt`, rate limiting на домен, обработку 3xx, user‑agent из настроек, retry с эксп. бэкофом, таймауты и ошибки возвращать в `SiteEntity.lastError`.
- **URL‑нормализация**
  - Проблема: ручные `.replace("www.","")`, работа со слешем в конце, `extractPath` по `substring` — легко сломать на схемах/сабдоменах/без слеша.
  - Исправление: использовать `URI`/`URL` парсинг, нормализовать хост (`www.`), схему, порты; приводить path аккуратно.
- **Статусы и ответы**
  - Проблема: для успеха в `stopIndexing()` возвращается `ErrorResponse` с `result=true`. Непоследовательно и вводит в заблуждение.
  - Исправление: завести отдельный `SuccessResponse` либо использовать единый DTO с полями `result`, `error`.
- **Сохранение индексов и частот**
  - Проблема: частота леммы увеличивается на 1 на страницу, а не на количество вхождений; `rank` записывается как `Integer` частоты из `frequencyMap`, TF/IDF не применяется; для каждой леммы создаётся отдельный рекорд — ок, но потом поиск делает N+1 запрос.
  - Исправление: хранить TF в `IndexEntity.rank`, IDF считать на этапе запроса или при обновлениях; оптимизировать запросы репозиториями с join‑ами и `IN`.

### Поиск и релевантность
- **N+1 и неэффективные запросы**
  - Проблема: `calculateLemmaRelevance` для каждой страницы снова делает `findByLemmaId`, и фильтрует на стороне Java.
  - Исправление: один запрос по страницам и леммам с агрегацией на SQL уровне (JOIN `index`, `page`, `lemma` и `GROUP BY page_id`), вернуть суммы rank.
- **Фильтрация частых лемм**
  - Проблема: порог `threshold = pageCount * 0.8` и фильтр `globalFreq <= threshold`. Это исключает высокочастотные, но при пустых страницах/малых наборах может давать пустой результат.
  - Исправление: хранить DF (число страниц с леммой) отдельно и использовать IDF; параметризовать порог и игнорировать стоп‑слова.
- **Сниппеты и XSS**
  - Проблема: `snippet = snippet.replaceAll("(?i)"+lemma, "<b>$0</b>")` без экранирования — инъекции/ломка HTML при спецсимволах; регэксп на сырые леммы.
  - Исправление: экранировать текст, использовать безопасную подсветку (HTML escape + wrap matches), леммы экранировать в RegExp `Pattern.quote`.

### Контроллер и обработка ошибок
- **Одинаковое сообщение об ошибке для всех исключений**
  - Проблема: клиент не понимает, что произошло; 401/403 смешаны.
  - Исправление: вернуть структурированные ошибки с кодом, сообщением, деталями; SecurityException — убрать если безопасности нет.
- **Валидация входа**
  - Проблема: `/indexPage` не валидирует URL, что может привести к краху скачивания.
  - Исправление: валидация формата URL, принадлежности домену, нормализация.

### Доменные модели и репозитории
- **Связи по ID вместо отношений**
  - Проблема: `IndexEntity` хранит `lemmaId` как `Integer`, а не `@ManyToOne LemmaEntity`. Это ломает навигацию и каскадирование.
  - Исправление: заменить на полноценные JPA‑ссылки `@ManyToOne` к `LemmaEntity` и `PageEntity` с индексацией по колонкам; в репозиториях использовать сигнатуры по сущностям.
- **Индексы БД**
  - Проблема: нет миграций/индексов по полям поиска (`lemma_id`, `page_id`, `(lemma_id, page_id)`, `site_id`, `path` уникальный).
  - Исправление: Flyway миграции с индексами и уникальными ограничениями (`page(site_id, path)` уникальный).

### Логи и шум
- **Логирование Hibernate выключено полностью**
  - Проблема: диагностика сложна, а `show-sql: true` при этом включено.
  - Исправление: dev — `org.hibernate.SQL: DEBUG`, prod — OFF, но без `show-sql`.

### UX и API
- **GET для запуска долгих задач**
  - Проблема: `/startIndexing`, `/stopIndexing` — GET для мутаций, не идемпотентно.
  - Исправление: сменить на POST.
- **Пагинация поиска отсутствует**
  - Проблема: большие ответы грузят сеть.
  - Исправление: добавить `offset`/`limit`, сортировку по релевантности/дате.

### Что бы я сделал в первую очередь
- Обновил до Spring Boot 3.3.x; убрал лишние логирующие зависимости; обновил драйвер MySQL.
- Развёл профили конфигураций (`dev`, `docker`, `prod`), убрал секреты из репозитория; `ddl-auto` по профилям.
- Починил архитектуру: `SearchService` не реализует репозиторий; `StatisticsService` в пакет `services`.
- Привёл индексацию к безопасной: без глобального удаления, единый пул, транзакции на юнит работы.
- Нормализовал URL/парсинг путей; исправил ответы API (DTO успеха/ошибки).
- Оптимизировал поиск: SQL‑агрегация релевантности, индексы БД, пагинация, безопасная подсветка сниппетов.

Если хотите, могу предложить конкретные правки по файлам (сигнатуры репозиториев, JPA‑связи в `IndexEntity`, конфиги профилей, миграции Flyway) и внести их правками кода.

- Я просмотрел конфиги и ключевые классы. Дальше могу подготовить точечные edits: рефакторинг `SearchService`/`StatisticsService`, профили конфигурации и безопасная подсветка сниппетов.
