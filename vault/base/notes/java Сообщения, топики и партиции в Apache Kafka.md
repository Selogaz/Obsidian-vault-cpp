---
tags:
  - note/specific/code
  - category/java
aliases:
  - Сообщения, топики и партиции в Apache Kafka
deck: obsidian::java
created: 2025-09-26T14:25:03+03:00
updated: 2025-09-26T14:42:35+03:00
---

**Сообщения, топики и партиции в Apache Kafka**
—
Сообщение - единица полезной информации. Каждое сообщение состоит из ключа, значения (payload), времени добавления и заголовков (headers). По умолчанию каждое сообщение ограничено 1МБ. Сообщения при чтении не удаляются. Это основное отличие Кафки от других месседж брокеров.

Ключ используется для определения партиции, если она не задана явно. Может быть равен null или не указываться вообще.

Значение хранится в виде массива байтов. Чтобы прочитать содержимое, его нужно десериализовать.

Заголовки - блок метаданных по типу ключ-значение. Что можно записать в заголовки:
- id для трассировки (trace IDs)
- временные метки
- данные о схеме сериализации

Топик - категория сообщений Kafka. "oders", "notifications"
Могут быть разделены на партиции: orders-1, orders-2. Сообщения хранятся упорядоченно только в пределах одной партиции.

Партиции - упорядоченная последовательность сообщений в рамках одного топика. Партиции помогают распределить нагрузку и масштабировать систему. Партиции позволяют одновременно записывать и читать сообщения несколькими продюсерами и консьюмерами.

В какую партицию попадает сообщение?
- Если пользователь задал партицию явно, то в неё
- Если задан ключ, номер партиции вычисляется как хэш (ключ) % число_операций
- Если партиция и ключ не указаны, сообщения равномерно распределяются между партициями.

По умолчанию используется схема sticky partitioner. Сообщения собираются в [[java batch батч|батчи]] (набор сообщений) и отправляются в определенную партицию, для следующего батча целевая партиция меняется.

В старых версиях Kafka использовался алгоритм round-robin, когда сообщения распределяются по партициям по кругу.
![[java kafka offset]]

# Как хранятся партиции

Партиции хранятся на диске, что позволяет долговременно хранить сообщения, причем запись на диск происходит сразу при поступлении сообщения..

Физически партиция состоит из одного или нескольких файлов, которые называются сегменты. Сегменты нужны, чтобы работать не с одним большим файлом, а с небольшими файлами фиксированного размера. Так проще и быстрее.

Данные из партиций удаляются либо по времени, либо по размеру. По умолчанию хранятся не менее 7 дней. Удаление происходит посегментно, с самого старого сегмента.

Посмотреть, как выглядит топик и партиция на диске, можно в папке kafka-logs. Для топика orders с 3 партициями на диске будет создано 3 папки: orders-1, orders-2, orders-3. В каждой папке будет несколько файлов с данными(сегментов) и орг. информация.

# Типы оффсетов

Термин "оффсет" может по-разному использоваться в разных источниках.
- Оффсет партиции - позиция сообщения внутри партиции. Не меняется и хранится внутри партиции
- Текущий оффсет - оффсет, с которого [[java основные сущности Kafka#Consumers|consumer]] в данный момент читает сообщения. Меняется и хранится на консьюмере
- Commited Offset (зафиксированный оффсет) - оффсет, который [[java основные сущности Kafka#Consumers|consumer]] зафиксировал (закоммитил) в [[java основные сущности Kafka#Broker|брокере]], показывающий, что все сообщения до этого оффсета были успешно обработаны. Хранится в специальном внутреннем топике _consumer_offsets.
- Нужно для корректной работы [[java основные сущности Kafka#Consumer Group|consumer group]].

# Дополнительные материалы
[[Лучшие практики использования хэдеров]]
[[Схемы именования топиков]]
[[Как выбрать число партиций и реплик для топика]]
[[Как отправлять сообщения больше 1МБ]]
